# ============================================================
# TRACEABILITY SCHEMA — mlops4ofp (versión ampliada variantes)
# ============================================================

version: "1.1"

metadata:
  description: "Esquema de trazabilidad para activos generados en el workflow MLOps4OFP con soporte para variantes."
  compatible_traceability_format: ">=1.0"

fields:

  stage:
    type: string
    required: true

  timestamp:
    type: string
    required: true

  inputs:
    type: list
    required: false

  outputs:
    type: list
    required: false

  params:
    type: dict
    required: false

  git:
    type: dict
    required: false

  variant:
    type: string
    required: false

  parent_variant:
    type: string
    required: false

  parent_variants:
    type: list
    element_type: string
    required: false


# ============================================================
# REGLAS DE PARÁMETROS POR FASE
# ============================================================

param_rules:

  "01_explore":
    raw_dataset_path:
      type: string
      required: true
      
    cleaning_strategy:
      type: string
      enum: ["none", "basic", "full"]
      required: true

    nan_values:
      type: list          # validaremos que sea lista
      element_type: number   # validaremos que todos los elementos sean numéricos
      required: true

    error_values_by_column:
      type: dict          # debe ser diccionario
      required: true

    max_lines:
      type: integer
      required: false

    first_line:
      type: integer
      required: false


  "02_prepareeventsds":
    band_thresholds_pct:
      type: list
      element_type: number
      required: true

    event_strategy:
      type: string
      enum: ["levels", "transitions", "both"]
      required: true

    nan_handling:
      type: string
      enum: ["keep", "discard"]
      required: true

    parent_variant:
      type: string
      required: true
      regex: "^v[0-9]{3}$"

    Tu:
      type: number
      required: false

  "03_preparewindowsds":

    OW:
      type: number
      required: true

    LT:
      type: number
      required: true

    PW:
      type: number
      required: true

    Tu:
      type: number
      required: false

    window_strategy:
      type: string
      enum: ["synchro", "asynOW", "withinPW", "asynPW"]
      required: true

    nan_strategy:
      type: string
      enum: ["preserve", "discard"]
      required: true

    variant_id:
      type: string
      regex: "^v[0-9]{3}$"
      required: true

    parent_variant:
      type: string
      required: true
      regex: "^v[0-9]{3}$"

  "04_targetengineering":

    prediction_name:
      type: string
      required: true
      regex: "^[a-z0-9_]+$"

    prediction_objective:
      type: dict
      required: true

    parent_variant:
      type: string
      required: true
      regex: "^v[0-9]{3}$"

  "05_modeling":
    _free_keys: ["search_space"]

    parent_variant:
      type: string
      required: true
      regex: "^v[0-9]{3}$"

    model_family:
      type: string
      required: true
      enum:
        - sequence_embedding
        - dense_bow
        - cnn1d

    automl:
      type: dict
      required: true

    training:
      type: dict
      required: true

    imbalance:
      type: dict
      required: true

    evaluation:
      type: dict
      required: true

    metrics:
      type: dict
      required: true


  "06_packaging":

    parent_variants_f05:
      type: list
      element_type: string
      required: true

    temporal:
      type: dict
      required: false

    notes:
      type: string
      required: false

  "07_deployrun":

    parent_variant_f06:
      type: string
      required: true
      regex: "^v[0-9]{3}$"

    runtime:
      type: dict
      required: true

    sample_size:
      type: number
      required: false

  